from crunchbase.items import CrunchbaseItem
from urlparse import urlparse

class HtmlParser:    
    @staticmethod
    def extract_item(x):
        item = CrunchbaseItem()
        business_name = x.select("//div[@id='col2_internal']/h1[@class='h1_first']/text()[1]").extract()
        if HtmlParser.not_empty(business_name):
            item['business_name'] = business_name[0].strip(" \t\n\r")
        else:
            item['business_name'] = '0'
        
        about = x.select("//div[@id='col2_internal']/p/text()").extract()
        if HtmlParser.not_empty(about):
            item['about'] = '<br/>'.join(x.strip(" \t\n\r") for x in about)
        else:
            item['about'] = '0'
            
        address = x.select("//div[@id='col1']/div[@class='col1_content']/div[@class='col1_office_address']")
        street_address = address.select('text()').extract()
        if HtmlParser.not_empty(street_address):
            item['street_address'] = street_address[0].strip()
        else:
            item['street_address'] = '0'
            
  
        city = address.select(".//a[contains(@href, 'city')]/text()").extract()
        if HtmlParser.not_empty(city):
            item['city'] = city[0].strip()
        else:
            item['city'] = '0'
            
        state = address.select(".//a[contains(@href, 'state')]/text()").extract()
        if HtmlParser.not_empty(state):
            item['state'] = state[0].strip()
        else:
            item['state'] = '0'
        
        zip_code = address.select(".//a[contains(@href, 'zip')]/text()").extract()
        if HtmlParser.not_empty(zip_code):
            item['zip_code'] = zip_code[0].strip()
        else:
            item['zip_code'] = '0'
            
        country = address.select(".//a[contains(@href, 'country')]/text()").extract()
        if HtmlParser.not_empty(country):
            item['country'] = country[0].strip()
        else:
            item['country'] = '0'
        
        tables = x.select("//div[@id='col1']/div[@class='col1_content']/table")
        for tr in tables.select(".//tr"):
            label = tr.select(".//td[@class='td_left']/text()").extract()
            if HtmlParser.not_empty(label):
                l = label[0].strip(" \t\n\r").lower()
                if l == 'website':
                    v = tr.select(".//td[@class='td_right']/a/@href").extract()
                    if HtmlParser.not_empty(v):
                        domain = v[0].strip(" \t\n\r")
                        item['website'] = domain
                        
                        url = urlparse(domain)
                        item['username'] =  url.hostname()
                    else:
                        item['website'] = '0'
                elif l == 'email':
                    v = tr.select(".//td[@class='td_right']/a/@title").extract()
                    if HtmlParser.not_empty(v):
                        item['email'] = v[0].strip(" \t\n\r")
                    else:
                        item['email'] = '0'
                elif l == 'phone':
                    v = tr.select(".//td[@class='td_right']/text()").extract()
                    if HtmlParser.not_empty(v):
                        item['phone'] = v[0].strip(" \t\n\r")
                    else:
                        item['phone'] = '0'
                elif l == 'category':
                    v = tr.select(".//td[@class='td_right']/a/text()").extract()
                    if HtmlParser.not_empty(v):
                        item['category'] = v[0].strip(" \t\n\r")
                    else:
                        item['category'] = '0'
        return item
    @staticmethod
    def not_empty(data):
        if data and len(data) >= 1:
            return True
        return False
